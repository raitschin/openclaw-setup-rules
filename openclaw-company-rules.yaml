# ============================================================================
# OpenClaw Company Rules â€” GLXY / attractsoft
# ============================================================================
#
# Company-wide rules for all OpenClaw instances.
# Contains NO personal data, tokens, or individual preferences.
#
# This file only includes rules that go BEYOND OpenClaw's built-in defaults.
# Things like memory management, heartbeat behavior, group chat etiquette,
# platform formatting, and workspace structure are already handled by OpenClaw
# out of the box and are NOT repeated here.
#
# Usage:
#   1. New instance â†’ import rules from this file into AGENTS.md
#   2. Rule update  â†’ update this file on GitHub, sync all instances
#   3. Export       â†’ any instance can export its rules back to this format
#
# GitHub: raitschin/openclaw-setup-rules
# ============================================================================

version: "2.2.0"
last_updated: "2026-02-18"
updated_by: "Clark (initial export)"
organization: "GLXY / attractsoft"

# ============================================================================
# SECTION 1: Deployment Rules
# ============================================================================
deployment:
  description: "Production and staging deployment guardrails"
  severity: CRITICAL

  rules:
    - id: DEPLOY-001
      name: "Production deployment requires explicit approval"
      rule: |
        NEVER deploy to production without EXPLICIT approval from the responsible owner.
        - No push to `main` branch without approval
        - No production deploy hook without approval
        - No merge to `main` without approval
        - No exceptions. Not even "it's just a small fix". NONE.
      severity: CRITICAL

    - id: DEPLOY-002
      name: "Staging first"
      rule: |
        ALWAYS work on and deploy to `staging` first.
        Only after successful testing on staging AND explicit confirmation
        from the owner may production be deployed.
        Workflow: staging branch â†’ test â†’ PR/merge to main â†’ production
      severity: CRITICAL

    - id: DEPLOY-003
      name: "Verify deployments"
      rule: |
        GitHub webhooks don't always trigger automatically.
        Manually trigger deploy hooks when needed and verify the deployment succeeded.
      severity: HIGH

# ============================================================================
# SECTION 2: Development Workflow (BMad Method)
# ============================================================================
development:
  description: "Development workflow following the BMad method â€” applies to ALL projects"
  severity: CRITICAL

  rules:
    - id: DEV-001
      name: "No code without an issue"
      rule: |
        Not a single line of code may be written before a GitHub issue exists.
        This applies to ALL repos, ALL changes â€” features, bugfixes, refactoring, cleanup.
        Sub-agents must also have an issue before they implement anything.
        No exceptions. No "let me just quickly do this".
      severity: CRITICAL

    - id: DEV-002
      name: "Use issue templates"
      rule: |
        Every issue MUST be created from a template:
        - Feature: `.github/ISSUE_TEMPLATE/feature.md`
        - Bug: `.github/ISSUE_TEMPLATE/bug.md`
        - Change Request: `.github/ISSUE_TEMPLATE/change-request.md`
        Labels: `feature`, `bug`, `epic`, `marketing`
      severity: HIGH

    - id: DEV-003
      name: "BMad planning (top-down)"
      rule: |
        Every development follows this structure:
        1. Create Epic â†’ contains all stories
        2. Derive Stories from Epic â†’ clear user stories with acceptance criteria
        3. Define Tasks per Story â†’ concrete technical tasks
        4. Create Issues per Task â†’ from templates, with `ref #Epic`
      severity: HIGH

    - id: DEV-004
      name: "TDD â€” Red-Green-Refactor"
      rule: |
        Test-Driven Development is mandatory:
        ðŸ”´ RED: Write tests FIRST â€” tests must FAIL (validates test correctness)
        ðŸŸ¢ GREEN: Write minimal code until all tests pass
        ðŸ”µ REFACTOR: Improve code structure, tests must stay green
        Commits reference the issue (`fixes #123`, `ref #123`)
      severity: CRITICAL

    - id: DEV-005
      name: "Code review"
      rule: |
        - Code review is mandatory before merge
        - Check: logic, edge cases, security, performance
        - Run all tests â€” no regressions, all new tests green
        - For UI/frontend changes: offer browser testing
        - Ideally: review with a DIFFERENT LLM than the one that implemented
      severity: HIGH

    - id: DEV-006
      name: "Definition of Done (per story)"
      rule: |
        A story is only done when:
        - [ ] All tasks/subtasks checked off
        - [ ] All acceptance criteria met
        - [ ] Unit tests for core functionality
        - [ ] Integration tests where needed
        - [ ] All tests green (no regressions)
        - [ ] File list complete
        - [ ] Dev agent record documented
        - [ ] Change log updated
      severity: HIGH

    - id: DEV-007
      name: "Commit messages reference issues"
      rule: |
        Every commit MUST reference its associated issue:
        - `fixes #XX` â€” when the commit closes the issue
        - `ref #XX` â€” when the commit contributes to the issue
        No commits without issue references.
      severity: HIGH

# ============================================================================
# SECTION 3: BMad Workflow Files
# ============================================================================
bmad:
  description: "BMad method file paths and workflow structure (relative to project root)"

  paths:
    workflow_engine: "_bmad/core/tasks/workflow.xml"
    dev_story_workflow: "_bmad/bmm/workflows/4-implementation/dev-story/"
    config: "_bmad/bmm/config.yaml"
    story_template: "_bmad/bmm/workflows/4-implementation/create-story/template.md"
    story_output: "_bmad-output/implementation-artifacts/"
    code_review: ".claude/commands/bmad-bmm-code-review.md"
    create_story: ".claude/commands/bmad-bmm-create-story.md"
    create_epics: ".claude/commands/bmad-bmm-create-epics-and-stories.md"
    sprint_planning: ".claude/commands/bmad-bmm-sprint-planning.md"
    quick_dev: ".claude/commands/bmad-agent-bmm-quick-flow-solo-dev.md"

  subagent_spawn_template: |
    Implement GitHub Issue #XX for repo {repo} (path: {path}).

    **MANDATORY: Follow BMad Dev-Story Workflow!**
    1. Read story file: `_bmad-output/implementation-artifacts/{story-file}.md`
    2. Read BMad config: `_bmad/bmm/config.yaml`
    3. Follow dev-story workflow: `_bmad/bmm/workflows/4-implementation/dev-story/instructions.xml`

    **TDD is mandatory (Red-Green-Refactor):**
    - ðŸ”´ RED: Write tests FIRST â€” tests MUST fail
    - ðŸŸ¢ GREEN: Minimal code until tests pass
    - ðŸ”µ REFACTOR: Improve code, tests stay green

    **When done:**
    - Check off all tasks/subtasks in story file
    - Update file list
    - Fill in dev agent record
    - Set story status to "review"
    - Commit with `ref #XX` or `fixes #XX`

    Context: {relevant technical details}

  workflow_phases:
    phase_1_planning: |
      Before spawning (agent itself):
      1. Create GitHub issue from template
      2. Create story file under `_bmad-output/implementation-artifacts/`
      3. Update sprint status if applicable

    phase_2_implementation: |
      Spawn sub-agent with the template above.
      Sub-agent follows BMad dev-story workflow autonomously.

    phase_3_review: |
      After spawning (agent itself):
      1. Perform code review (ideally with a different LLM)
      2. Push to staging and deploy
      3. Ask owner to test
      4. After successful test: merge to main â†’ production

# ============================================================================
# SECTION 4: Group Scopes
# ============================================================================
group_scopes:
  description: "Every group chat has a defined scope. The agent must stay within it."
  severity: CRITICAL

  rules:
    - id: SCOPE-001
      name: "Read scope before responding"
      rule: |
        Every group chat has a scope file under `scopes/`.
        Before answering in ANY group:
        1. Read the scope file for that group's Chat-ID
        2. Check if the request falls within the allowed scope
        3. If NOT in scope â†’ politely decline and redirect to the correct group
        4. NEVER share data from other projects or private user context
      severity: CRITICAL

    - id: SCOPE-002
      name: "Scope file structure"
      rule: |
        Each scope file must define:
        - Chat-ID: the group identifier
        - Purpose: what the group is for (one sentence)
        - Allowed: list of permitted activities and repos
        - Forbidden: list of explicitly prohibited activities
        - Context Files: paths the agent may reference for this group
      severity: HIGH

    - id: SCOPE-003
      name: "Adding new groups"
      rule: |
        When creating a new group:
        1. Create scope file under `scopes/group-{name}.md`
        2. Add Chat-ID to OpenClaw config (channels.telegram.groups)
        3. Add reference to AGENTS.md group scopes section
        4. Commit scope file to the company rules repo
      severity: HIGH

  file_convention: "scopes/group-{project}-{purpose}.md"

# ============================================================================
# SECTION 5: Session Configuration
# ============================================================================
session:
  description: "Session persistence settings â€” especially for group chats"

  config:
    resetByType:
      group:
        mode: "idle"
        idleMinutes: 480  # 8 hours â€” group sessions survive gateway restarts

  rules:
    - id: SESSION-001
      name: "Group session persistence"
      rule: |
        Group chat sessions use idle-based reset (not daily reset).
        Default: 480 minutes (8 hours) idle timeout.
        This prevents group context loss during gateway restarts
        (config patches, updates) which would otherwise create a new
        session ID and lose all prior conversation context.
      severity: HIGH

    - id: SESSION-002
      name: "Avoid unnecessary gateway restarts"
      rule: |
        Every gateway restart (config.patch, update, etc.) re-evaluates
        session expiry. Batch config changes together when possible to
        minimize restarts and reduce the risk of session context loss.
      severity: MEDIUM

# ============================================================================
# SECTION 6: Group Memory Persistence
# ============================================================================
group_memory:
  description: "Persistent memory files for group chats to survive session resets and gateway restarts"
  severity: HIGH

  rules:
    - id: GMEM-001
      name: "Every group gets a persistent memory file"
      rule: |
        Every group chat MUST have a persistent memory file at:
          `memory/{group-name}-context.md`
        This file survives session resets, gateway restarts, and compactions.
        The scope file for the group MUST reference this memory file.
      severity: HIGH

    - id: GMEM-002
      name: "Read memory on session start"
      rule: |
        At the START of every group session (or when the session appears
        empty/new with no prior messages visible), the agent MUST read
        the group's persistent memory file BEFORE responding.
        This restores context that was lost during session resets.
      severity: CRITICAL

    - id: GMEM-003
      name: "Update memory after every meaningful exchange"
      rule: |
        After every meaningful exchange in a group, the agent MUST update
        the group's memory file:
        - Append to "Recent Messages" section (keep last ~30 exchanges)
        - Update "Active Tasks" section when tasks change
        - Update "Decisions & Context" for important decisions
        - Trim oldest messages when exceeding ~30 exchanges
      severity: HIGH

    - id: GMEM-004
      name: "Memory file structure"
      rule: |
        Each group memory file must contain:
        ```
        # {Group Name} â€” Persistent Memory
        ## Active Tasks
        ## Decisions & Context
        ## Recent Messages (last ~30 exchanges)
        ```
      severity: MEDIUM

  file_convention: "memory/{group-name}-context.md"

# ============================================================================
# SECTION 7: Security Tooling
# ============================================================================
security_tooling:
  description: "Company-wide security scanning tools"

  tools:
    - name: "Semgrep"
      type: "SAST (Static Application Security Testing)"
      install: "pip install semgrep"
      usage:
        quick_scan: 'semgrep --config "p/typescript" <path>'
        full_scan: 'semgrep --config auto <path>'
        owasp: 'semgrep --config "p/owasp-top-ten" <path>'
      rulesets:
        - "p/typescript"
        - "p/javascript"
        - "p/react"
        - "p/nodejs"
        - "p/owasp-top-ten"
        - "p/security-audit"

    - name: "Snyk"
      type: "SCA (Software Composition Analysis) + SAST"
      install: "npm install -g snyk"
      auth: "snyk auth (browser OAuth or API token)"
      usage:
        dependency_scan: "snyk test"
        code_scan: "snyk code test"
        monitor: "snyk monitor"

  rules:
    - id: SEC-001
      name: "Security scan before merge"
      rule: |
        Before every merge to staging or main:
        - Run Semgrep SAST scan (at least `p/typescript` or `--config auto`)
        - Run Snyk dependency scan (`snyk test`) â€” no critical/high vulnerabilities
        - Blocking findings must be resolved
      severity: HIGH

    - id: SEC-002
      name: "Regular scans"
      rule: |
        At least weekly:
        - `snyk monitor` on all active repos
        - Semgrep full scan (`--config auto`)
        - Document results in daily notes
      severity: MEDIUM

    - id: SEC-003
      name: "New dependencies"
      rule: |
        For every new dependency:
        - Run `snyk test` before committing
        - Check license compatibility
        - Verify no known vulnerabilities
      severity: HIGH

# ============================================================================
# SECTION 8: GitHub Repositories
# ============================================================================
repositories:
  description: "Company GitHub repos and organization"
  organization: "attractsoft"

  repos:
    - name: "speaktomycrm"
      full: "attractsoft/speaktomycrm"
      description: "Voice-to-CRM via Telegram"

    - name: "florentin-app"
      full: "attractsoft/florentin-app"
      description: "Automation workflows to API products (SaaS enabler)"

    - name: "anychat"
      full: "attractsoft/anychat"
      description: "Chat frontend (part of anymize.ai)"

    - name: "anymize"
      full: "attractsoft/anymize"
      description: "GDPR-compliant LLM anonymization"

    - name: "anymize-context"
      full: "attractsoft/anymize-context"
      description: "Context repo: roadmap, pricing, BMad workflow"

  labels:
    - "feature"
    - "bug"
    - "epic"
    - "marketing"

# ============================================================================
# META: How to use this file
# ============================================================================
#
# IMPORT (new instance):
#   1. Copy openclaw-company-rules.yaml to the workspace
#   2. Instruct the agent:
#      "Import the company rules from openclaw-company-rules.yaml
#       into your AGENTS.md. Personal sections (SOUL.md, USER.md)
#       remain individual."
#   3. The agent merges the rules into its AGENTS.md
#
# EXPORT (existing instance):
#   1. Instruct the agent:
#      "Export your current company rules from AGENTS.md
#       to openclaw-company-rules.yaml format. No personal data."
#   2. The agent updates openclaw-company-rules.yaml with a new version
#
# SYNC (reconcile):
#   1. Pull current version from GitHub
#   2. Instruct the agent:
#      "Reconcile your AGENTS.md with openclaw-company-rules.yaml.
#       Show differences. Adopt new rules, keep personal customizations."
#   3. Bump version + commit
#
# VERSIONING:
#   - Major: Breaking changes (rules removed or fundamentally changed)
#   - Minor: New rules added
#   - Patch: Clarifications, wording improvements
#
# IMPORTANT:
#   When updating this file, the README.md MUST also be updated.
#   No YAML change without a README change. The README is the
#   human-readable documentation of all rules.
